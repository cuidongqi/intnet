(function(){!function(t){var e,i,n,r,o,a,s,u,h,c,l;return n={$mirror:null,css:["overflowY","height","width","paddingTop","paddingLeft","paddingRight","paddingBottom","marginTop","marginLeft","marginRight","marginBottom","fontFamily","borderStyle","borderWidth","wordWrap","fontSize","lineHeight","overflowX"],init:function(e){var i,n;return i=t("<div></div>"),n={position:"absolute",left:-9999,top:0,zIndex:-2e4,"white-space":"pre-wrap"},t.each(this.css,function(t,i){return n[i]=e.css(i)}),i.css(n),this.$mirror=i,e.after(i),this},setContent:function(t){return this.$mirror.html(t),this},getFlagRect:function(){var t,e,i;return t=this.$mirror.find("span#flag"),e=t.position(),i={left:e.left,top:e.top,bottom:t.height()+e.top},this.$mirror.remove(),i}},e=function(e){var o,a=this;return o=this.$inputor=t(e),this.options={},this.query={text:"",start:0,stop:0},this._cache={},this.pos=0,this.flags={},this.theflag=null,this.search_word={},this.view=i,this.mirror=n,o.on("keyup.inputor",function(t){var e,i;if(i=40===t.keyCode||38===t.keyCode,e=!(i&&a.view.isShowing()))return a.lookup()}).on("mouseup.inputor",function(t){}),this.init(),r("At.new",o[0]),this},e.prototype={constructor:e,init:function(){var t=this;return this.$inputor.on("keyup.inputor",function(e){return t.onkeyup(e)}).on("keydown.inputor",function(e){return t.onkeydown(e)}).on("scroll.inputor",function(e){return t.view.hide()}).on("blur.inputor",function(e){return t.view.hide(1e3)}),r("At.init",this.$inputor[0])},reg:function(e,i){var n,o,a;return n={},t.isFunction(i)?n.callback=i:n=i,a=(o=this.options)[e]||(o[e]=t.fn.atWho.default),this.options[e]=t.extend({},a,n),r("At.reg",this.$inputor[0],e,i)},dataValue:function(){var t,e;return(e=this.search_word[this.theflag])?e:(t=/data-value=["']?\$\{(\w+)\}/g.exec(this.getOpt("tpl")),this.search_word[this.theflag]=u(t)?null:t[1])},getOpt:function(t){try{return this.options[this.theflag][t]}catch(t){return null}},rect:function(){var e,i,n,r,o,a,s,u,h,c;return e=this.$inputor,document.selection?(i=document.selection.createRange(),h=i.boundingLeft+e.scrollLeft(),c=i.boundingTop+t(window).scrollTop()+e.scrollTop(),r=c+i.boundingHeight,{top:c-2,left:h-2,bottom:r-2}):(o=function(t){return t.replace(/</g,"&lt").replace(/>/g,"&gt").replace(/`/g,"&#96").replace(/"/g,"&quot").replace(/\r\n|\r|\n/g,"<br />")},u=e.val().slice(0,this.pos-1),a="<span>"+o(u)+"</span>",a+="<span id='flag'>@</span>",s=e.offset(),n=this.mirror.init(e).setContent(a).getFlagRect(),h=s.left+n.left-e.scrollLeft(),c=s.top-e.scrollTop(),r=c+n.bottom,c+=n.top,{top:c,left:h,bottom:r+2})},cache:function(t){var e,i;return e=this.query.text,this.getOpt("cache")&&e?(i=this._cache)[e]||(i[e]=t):null},getKeyname:function(){var e,i,n,o,a,s,h,c,l=this;return e=this.$inputor,c=e.val(),i=e.caretPos(),h=c.slice(0,i),a=null,t.each(this.options,function(t){var e,i;if(i=new RegExp(t+"([A-Za-z0-9_+-]*)$|"+t+"([^\\x00-\\xff]*)$","gi"),e=i.exec(h),!u(e))return a=e[2]?e[2]:e[1],l.theflag=t,!1}),"string"==typeof a&&a.length<=20?(s=i-a.length,n=s+a.length,this.pos=s,o={text:a.toLowerCase(),start:s,end:n}):this.view.hide(),r("At.getKeyname",o),this.query=o},replaceStr:function(t){var e,i,n,o,a,s;return e=this.$inputor,n=this.query,o=e.val(),i=this.getOpt("display_flag")?0:this.theflag.length,a=o.slice(0,n.start-i),s=a+t+o.slice(n.end),e.val(s),e.caretPos(a.length+t.length),e.change(),r("At.replaceStr",s)},onkeyup:function(e){var i;if(i=this.view,i.isShowing()){switch(e.keyCode){case 27:e.preventDefault(),i.hide();break;default:t.noop()}return e.stopPropagation()}},onkeydown:function(e){var i;if(i=this.view,i.isShowing()){switch(e.keyCode){case 27:e.preventDefault(),i.hide();break;case 38:e.preventDefault(),i.prev();break;case 40:e.preventDefault(),i.next();break;case 9:case 13:if(!i.isShowing())return;e.preventDefault(),i.choose();break;default:t.noop()}return e.stopPropagation()}},renderView:function(t){return r("At.renderView",this,t),t=l(t,this.dataValue()),t=t.splice(0,this.getOpt("limit")),t=h(t),t=c.call(this,t),this.view.render(this,t)},lookup:function(){var e,i,n;return!!(n=this.getKeyname())&&(r("At.lookup.key",n),u(i=this.cache())&&u(i=this.lookupWithData(n))?t.isFunction(e=this.getOpt("callback"))?e(n.text,t.proxy(this.renderView,this)):this.view.hide():this.renderView(i),t.noop())},lookupWithData:function(e){var i,n,r=this;return i=this.getOpt("data"),t.isArray(i)&&0!==i.length&&(n=t.map(i,function(i,n){var o,a,s;try{a=t.isPlainObject(i)?i[r.dataValue()]:i,s=new RegExp(e.text.replace("+","\\+"),"i"),o=a.match(s)}catch(t){return null}return o?i:null})),n}},i={timeout_id:null,id:"#at-view",holder:null,_jqo:null,jqo:function(){var e;return e=this._jqo,e=u(e)?this._jqo=t(this.id):e},init:function(){var e,i,n=this;if(u(this.jqo()))return i="<div id='"+this.id.slice(1)+"' class='at-view'><ul id='"+this.id.slice(1)+"-ul'></ul></div>",t("body").append(i),e=this.jqo().find("ul"),e.on("mouseenter.view","li",function(i){return e.find(".cur").removeClass("cur"),t(i.currentTarget).addClass("cur")}).on("click",function(t){return t.stopPropagation(),t.preventDefault(),n.choose()})},isShowing:function(){return this.jqo().is(":visible")},choose:function(){var t,e;return t=this.jqo().find(".cur"),e=u(t)?this.holder.query.text+" ":t.attr(this.holder.getOpt("choose"))+" ",this.holder.replaceStr(e),this.hide()},rePosition:function(){var e;return e=this.holder.rect(),e.bottom+this.jqo().height()-t(window).scrollTop()>t(window).height()&&(e.bottom=e.top-this.jqo().height()),r("AtView.rePosition",{left:e.left,top:e.bottom}),this.jqo().offset({left:e.left,top:e.bottom})},next:function(){var e,i;return e=this.jqo().find(".cur").removeClass("cur"),i=e.next(),i.length||(i=t(this.jqo().find("li")[0])),i.addClass("cur")},prev:function(){var t,e;return t=this.jqo().find(".cur").removeClass("cur"),e=t.prev(),e.length||(e=this.jqo().find("li").last()),e.addClass("cur")},show:function(){return this.isShowing()||this.jqo().show(),this.rePosition()},hide:function(t){var e,i=this;return isNaN(t)?this.isShowing()?this.jqo().hide():void 0:(e=function(){return i.hide()},clearTimeout(this.timeout_id),this.timeout_id=setTimeout(e,300))},clear:function(t){return t===!0&&(this._cache={}),this.jqo().find("ul").empty()},render:function(e,i){var n,u;return!!t.isArray(i)&&(i.length<=0?(this.hide(),!0):(this.holder=e,e.cache(i),this.clear(),n=this.jqo().find("ul"),u=e.getOpt("tpl"),t.each(i,function(t,i){var h;return u||(u=o),h=a(u,i),r("AtView.render",h),n.append(s(h,e.query.text))}),this.show(),n.find("li:eq(0)").addClass("cur")))}},h=function(e){return t.map(e,function(e,i){return t.isPlainObject(e)||(e={id:i,name:e}),e})},a=function(t,e){var i;try{return i=t.replace(/\$\{([^\}]*)\}/g,function(t,i,n){return e[i]})}catch(t){return""}},s=function(t,e){return u(e)?t:t.replace(new RegExp(">\\s*(\\w*)("+e.replace("+","\\+")+")(\\w*)\\s*<","ig"),function(t,e,i,n){return"> "+e+"<strong>"+i+"</strong>"+n+" <"})},c=function(t){var e,i,n,r,o,a,s;for(e=this.dataValue(),n=this.query.text,r=[],a=0,s=t.length;a<s;a++)i=t[a],o=i[e],(o.toLowerCase().indexOf(n)!==-1||o.match(/[^\x00-\xff]/gi))&&(i.order=o.toLowerCase().indexOf(n),r.push(i));return r.sort(function(t,e){return t.order-e.order}),r},l=function(e,i){var n;return n=[],t.map(e,function(e,r){var o;if(o=t.isPlainObject(e)?e[i]:e,t.inArray(o,n)<0)return n.push(o),e})},u=function(e){return!e||t.isPlainObject(e)&&t.isEmptyObject(e)||t.isArray(e)&&0===e.length||e instanceof t&&0===e.length||void 0===e},o="<li id='${id}' data-value='${name}'>${name}</li>",r=function(){},t.fn.atWho=function(n,r){return i.init(),this.filter("textarea, input").each(function(){var i,o;return i=t(this),o=i.data("AtWho"),o||i.data("AtWho",o=new e(this)),o.reg(n,r)})},t.fn.atWho.default={data:[],choose:"data-value",callback:null,cache:!0,limit:10,display_flag:!0,tpl:o}}(window.jQuery),function(t){var e,i;return e=function(t){var e,i,n,r,o,a,s,u;return document.selection?(a=document.selection.createRange(),o=0,a&&a.parentElement()===t&&(r=t.value.replace(/\r\n/g,"\n"),n=r.length,u=t.createTextRange(),u.moveToBookmark(a.getBookmark()),i=t.createTextRange(),i.collapse(!1),u.compareEndPoints("StartToEnd",i)>-1?s=e=n:(s=-u.moveStart("character",-n),e=-u.moveEnd("character",-n)))):s=t.selectionStart,s},i=function(t,e){var i;return document.selection?(i=t.createTextRange(),i.move("character",e),i.select()):t.setSelectionRange(e,e)},t.fn.caretPos=function(t){var n;if(n=this[0],n.focus(),t){var r=i(n,t);return r}var r=e(n);return r}}(window.jQuery)}).call(this);